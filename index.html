<!doctype html>
<head>
	<title>Dot: Interactive dot plot for genome-genome alignments</title>
	
	<link rel="stylesheet" href="css/bootstrap.min.css" />
	<style>
		body { 
			margin: 0; 
			font-family: Arial;
		}
		svg, canvas {
			position: absolute;
			top: 0;
			left: 0;
		}
		h2 {
			padding: 2vmin 2vmin 2vmin 2vmin;
		}
		.panel-body {
			overflow-x: scroll;
		}
		#examples a {
			display: block;
		}
		#wrapper {
			display: flex;
		}
		#left {
			padding: 10px;
			width: 100px;
		}
		#right {
			padding: 10px;
			width: 500px;
		}
		#plotting-area {
			position: relative;
		}
	</style>
	<script src="js/d3.v4.min.js"></script>
	<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
	<script src="js/ramda.min.js"></script>
	<script src="js/MultiSegmentScale.js"></script>
	<script src="js/InputPanel.js"></script>
	<script src="js/Dot.js"></script>
</head>
<body>

<h2>Dot: Interactive dot plot for genome-genome alignments</h2>

<div id="wrapper">
	<div id="left">
		<div class="panel panel-default">
			<div class="panel-heading">Examples</div>
			<div id="examples" class="panel-body"></div>
		</div>
		<div class="panel panel-default">
			<div class="panel-heading">Custom inputs</div>
			<div id="inputPanel" class="panel-body"></div>
		</div>
		<div class="panel panel-default">
		<div class="panel-heading">Getting started</div>
			<div class="panel-body">
				<ol>
					<li>Select an example below or enter your own alignments file URL. To generate the alignments file, see the <a href="https://dnanexus.github.io/dot">README</a></li>
					<li>Optionally add an annotation file in CSV format. The CSV file must have a header that includes the following fields: "ref,ref_start,ref_end,name" or "query,query_start,query_end,name", depending on which side the annotations belong to. </li>
					<li>Zoom in on a region of interest by dragging a rectangle around it. Zoom back out by double-clicking.</li>
				</ol>
			</div>
		</div>
		<div class="panel panel-default">
			<div class="panel-heading">Information</div>
			<div class="panel-body">
				Dot is open source at <a href="https://github.com/dnanexus/dot">https://github.com/dnanexus/dot</a>
			</div>
		</div>
	</div>
	<div id="right">
		<div id="plotting-area">

		</div>
	</div>
	
</div>

<script type='text/javascript'>

/* SET UP ENV */

var w = window,
	d = document,
	e = d.documentElement,
	g = d.getElementsByTagName('body')[0];



var _map = {	width: (w.innerWidth || e.clientWidth || g.clientWidth)*0.90,
				height: (w.innerHeight || e.clientHeight || g.clientHeight)*0.80,
				x: 'ref',
				y: 'query'
			};

var _app_area = d3.select('#plotting-area');

var panelSize = Math.min(_map.width*0.3, 300);
var plotAreaSize = _map.width - panelSize;

d3.select("#left").style("width", panelSize + "px");
d3.select("#right").style("width", plotAreaSize + "px")

var baseURL = location.protocol + '//' + location.host + location.pathname;

var examples = [
	{
		shortName: "S. cerevisiae",
		name: "Saccharomyces cerevisiae MHAP assembly", 
		url: baseURL + "?alignments=test_files/Saccharomyces_cerevisiae_MHAP_assembly.oriented_coords.csv"
	},
	{
		shortName: "A. thaliana (ref annotated)",
		name: "Arabidopsis thaliana MHAP assembly", 
		url: baseURL + "?alignments=test_files/Arabidopsis_thaliana_MHAP_assembly.oriented_coords.csv&annotations=test_files/TAIR10_genes.csv"
	},
	{
		shortName: "A. thaliana (query annotated)",
		name: "Arabidopsis thaliana MHAP assembly", 
		url: baseURL + "?alignments=test_files/Arabidopsis_thaliana_MHAP_assembly.oriented_coords.csv&annotations=test_files/fake_test_query_genes.csv"
	},
];

d3.select("#examples").selectAll("a").data(examples).enter().append("a")
	.attr("href", function(d) {return d.url})
	.html(function(d) {return d.shortName})
	.property("title", function(d) {return d.name});


/* PREPARE DATA and SCALES */

var _scales = {x: null, y: null};


var _dot;


/* Set up the Dot app */

_dot = new DotApp(_app_area, {height: _map.height, width: plotAreaSize});


/* Process inputs */

function setAlignmentData(source) {
	// Type these columns as numbers:
	var numericColumns = ["ref_length", "ref_start", "ref_end", "query_length", "query_start", "query_end", "alignment_length"];
	d3.csv(source, function(error,rows) {
		if (error) throw error;
		rows.map(function(d) {
			numericColumns.map(function(key) {return d[key] = Number(d[key]) });
		});
		_dot.setData(rows);
	});
}

function setAnnotationData(source) {
	d3.csv(source, function(error,rows) {
		if (error) throw error;
		_dot.addAnnotationData({key: source, data: rows});
	});
}

var inputSpec = {
	alignments: {name: "alignments", required: true, callback: setAlignmentData},
	annotations: {name: "annotations", required: true, callback: setAnnotationData},
};

var _input_area = d3.select("#inputPanel");

var _input_panel = new InputPanel({
	element: _input_area,
	spec: inputSpec,
});

	</script>
</body>


